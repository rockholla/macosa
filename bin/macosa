#!/bin/bash

macosa_bin_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$macosa_bin_dir/../"
source config/defaults.cfg
for user_config_file in $(pwd)/user/config/*.cfg; do
  [ -f "$user_config_file" ] || continue
  source "$user_config_file"
done

update=false
logout=false
passthru=""

function usage () {
   cat <<EOF
Usage: `basename "$0"` [-h] [-u] [-l]

Options:
  -h    Show this help
  -u    Run a MacOS software update before provisioning
  -l    Logout when finished

Other options:
  Anything you can pass to 'ansible-playbook' you can also pass to this script, for example:

    `basename "$0"` --tags=homebrew,client1

Ansible Playbook Help:
`ansible-playbook --help`

EOF
  exit 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h)
      usage
      shift
      ;;
    -u)
      update=true
      shift
      ;;
    -l)
      logout=true
      shift
      ;;
    *)
      passthru="$passthru $1"
      shift
      ;;
  esac
done

# Ask for sudo password and keep alive until this script finishes
echo $(cat ~/.macosa/.vaultpass) | sudo -S echo "Initializing sudo"
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

if [ -f user/reminders/before ]; then
  printf "There are some reminders for you before this run:\n"
  printf "\033[33m\n"
  cat user/reminders/before
  printf "\033[0m\n"
  read -rsp $'Press any key to continue...\n' -n1 key
fi

if $update; then
  ./bin/macosa_softwareupdate
fi

./bin/macosa_ruby

# Install Python

if ! brew ls --versions python &>/dev/null; then
  printf "Installing Python via Homebrew...\n"
  brew install python
else
  printf "Python is installed via Homebrew.\n"
fi

# Install python package biplist
if ! python -c "import biplist" &>/dev/null; then
  printf "Installing biplist...\n"
  pip install biplist
else
  printf "biplist is installed.\n"
fi

# Install Ansible
if ! command -v ansible &>/dev/null; then
  printf "Installing Ansible...\n"
  pip install ansible
else
  printf "Ansible is installed.\n"
fi

####################################
# Ansible Provisioning             #
####################################

# Install ansible requirements
if [ -f requirements.yml ]; then
  printf "Installing Ansible requirements...\n"
  ansible-galaxy install -r requirements.yml
fi

# Run the playbook
printf "Running main playbook against local connection...\n"
ansible-playbook -i inventory/all $passthru macos.yml

if [ -f user/reminders/after ]; then
  printf "There are some reminders for you after this run:\n"
  printf "\033[33m\n"
  cat user/reminders/after
  printf "\033[0m\n"
fi

if [ -f .logout ] || [ $logout == true ]; then
  printf "This run requires you to log out and back in:\n"
  ./bin/macosa_logout
  rm .logout
else
  exec bash ~/.bash_profile
fi