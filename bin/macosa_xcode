#!/bin/bash

# Install Xcode or Xcode cli tools

this_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
root="$this_dir/.."
install_type="${1:-tools}"
download_file_type="xip"

if [ $install_type == "tools" ]; then

  if ! xcode-select --print-path &>/dev/null; then
    printf "Installing Xcode tools...\n"
    say "To continue, please click install in the following popup window"
    # Prompt user to install the XCode Command Line Tools
    xcode-select --install &>/dev/null

    # Wait until the XCode Command Line Tools are installed
    until xcode-select --print-path &>/dev/null; do
      sleep 5
    done

    printf "Xcode tools are finished installing.\n"
  else
    printf "Xcode tools are already installed\n"
  fi

elif [[ "$install_type" =~ ^[0-9\.]+$ ]]; then

  xcode_version="$install_type"
  file_basename="Xcode_$xcode_version"
  version_parts=(${xcode_version//./ })
  major_version="${version_parts[0]}"
  if [[ $major_version < "8" ]]; then
    download_file_type="dmg"
  fi
  if [ $xcode_version == '8.3.2' ]; then
    file_basename="Xcode$xcode_version"
  fi

  # Mount and install
  if [ ! -d /Applications/Xcode.app ]; then
    printf "Installing Xcode...\n"
    if [ ! -f "$root/.downloads/$file_basename.$download_file_type" ]; then
      say "We can help you download Xcode automatically, please reed the following and respond to continue"
      read -rp $'We can try to download Xcode for you automatically, but you need to make sure you don\'t have two-factor authentication turned on for your Apple ID (https://appleid.apple.com/account/manage) and have access to Apple Developer resources.  Would you like to download Xcode automatically? [Y/n] ' response
      case "$response" in
        [yY][eE][sS]|[yY])
          (
            printf "OK, attempting to download Xcode...\n"
            if ! command -v adcdownload &>/dev/null; then
              source $HOME/.rvm/scripts/rvm
              gem install --no-rdoc --no-ri adcdownload
            fi
            backto=$(pwd)
            cd $root/.downloads/
            message="You may need to enter your Apple account credentials to start the download"
            say "$message"
            printf "$message...\n"
            adcdownload get http://adcdownload.apple.com/Developer_Tools/Xcode_$xcode_version/$file_basename.$download_file_type
            cd $backto
          )
          ;;
        *)
          read -rsp $'Please download Xcode from http://adcdownload.apple.com/Developer_Tools/Xcode_$xcode_version/$file_basename.$download_file_type.  Move the downloaded file to ~/.macosa/.downloads/, then press any key continue.\n' -n1 key
          ;;
      esac
    fi
    if [ $download_file_type == 'xip' ]; then
      if [ ! -s /tmp/Xcode.app ]; then
        rsync "$root/.downloads/$file_basename.$download_file_type" /tmp/
        open "/tmp/$file_basename.$download_file_type"
        printf "Waiting for Xcode xip to be extracted...\n"
        until [ -s /tmp/Xcode.app ]; do
          sleep 5
        done
      fi
      printf "Installing extracted Xcode.app to Applications...\n"
      echo $(cat ~/.macosa/.vaultpass) | sudo -S rsync -a /tmp/Xcode.app/ /Applications/Xcode.app
      rm "/tmp/$file_basename.$download_file_type"
    else
      echo $(cat ~/.macosa/.vaultpass) | sudo -S hdiutil attach "$root/.downloads/$file_basename.$download_file_type"
      printf "Installing Xcode from mount to Applications...\n"
      echo $(cat ~/.macosa/.vaultpass) | sudo -S cp -R /Volumes/Xcode/Xcode.app /Applications/Xcode.app
    fi

    printf "Automatically accepting the Xcode license\n"
    echo $(cat ~/.macosa/.vaultpass) | sudo xcodebuild -license accept 2>/dev/null

    # Unmount the installation image
    if mount | grep "on /Volumes/Xcode" &>/dev/null; then
      echo $(cat ~/.macosa/.vaultpass) | sudo -S hdiutil unmount "/Volumes/Xcode"
    fi
    printf "Xcode is finished installing.\n"
  else
    printf "Xcode application is already installed\n"
  fi

else
  printf "\033[33mWARNING: Invalid install type $install_type...ignorning\033[0m\n"
fi
