#!/bin/bash

install_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$install_dir"
source config/defaults.cfg
for user_config_file in user/config/*.cfg; do
  [ -f "$user_config_file" ] || continue
  source user_config_file
done

passthru=""

function usage () {
   cat <<EOF
Usage: `basename "$0"` [-h] [-x full|tools]

Options:
  -h                        Show this help
  -x [Xcode install type]   If "full", will ensure full XCode installation, if "tools" just installs XCode cli tools (default is "tools")

EOF
  exit 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h)
      usage
      shift
      ;;
    *)
      passthru="$passthru $1"
      shift
      ;;
  esac
done

if pwd | grep $HOME &> /dev/null; then
  printf "\033[31mYou're trying to run the install from the installation destination, just run 'macosa' instead to provision\033[0m\n"
  exit 1
fi

# Ask for sudo password and keep alive until this script finishes
sudo -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# disable computer and display sleep during install (assume that ansible config will set as it sees fit, so we don't need to reset)
sudo systemsetup -setcomputersleep Never
sudo systemsetup -setdisplaysleep Never

# Let's run a system software update first before installing
./bin/macosa_softwareupdate

printf "Installing MacOSa to your machine...\n"
# Install this repo to ~/.macosa
rsync -a --delete-before --progress . ~/.macosa

# initialize local variable file
echo "# This file is automatically generated during the MacOSa install" > ~/.macosa/user/vars/base.yml
echo "---" > ~/.macosa/user/vars/base.yml

# Capture and write out computer name to variables
read -p "What do you want to name this Mac? " machine_name
echo "computer_name: \"$machine_name\"" >> ~/.macosa/user/vars/base.yml

# Capture and write out sudo password to variables
read -s -p "What is the root password for this Mac? (will also be used as the Ansible vault password) " sudo_pass
echo "ansible_become_pass: \"$sudo_pass\"" >> ~/.macosa/user/vars/base.yml
echo $sudo_pass > ~/.macosa/.vaultpass

# Save the path to this install directory so we can auto-sync changes from the install location back to here
echo "macosa_install_source: \"$install_dir\"" >> ~/.macosa/user/vars/base.yml

printf "Running MacOSa script for local machine setup and provisioning...\n"
~/.macosa/bin/macosa -u -l $passthru
